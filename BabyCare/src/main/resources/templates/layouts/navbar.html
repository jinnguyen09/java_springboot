<div th:fragment="navbar">
    <div class="container-fluid border-bottom bg-light wow fadeIn" data-wow-delay="0.1s">
        <!-- Topbar -->
        <div class="container topbar bg-primary d-none d-lg-block py-2" style="border-radius: 0 40px">
            <div class="d-flex justify-content-between">
                <div class="top-info ps-2">
                    <small class="me-3"><i class="fas fa-map-marker-alt me-2 text-secondary"></i> <a href="#" class="text-white">TP Vinh, Nghệ An</a></small>
                    <small class="me-3"><i class="fas fa-envelope me-2 text-secondary"></i><a href="#" class="text-white">thiepthanhx03@gmail.com</a></small>
                    <small class="me-3"><i class="fas fa-phone me-2 text-secondary"></i><a href="#" class="text-white">0899073387</a></small>
                </div>
                <div class="top-link pe-2">
                    <a href="#" class="btn btn-light btn-sm-square rounded-circle"><i class="fab fa-facebook-f text-secondary"></i></a>
                    <a href="#" class="btn btn-light btn-sm-square rounded-circle"><i class="fab fa-twitter text-secondary"></i></a>
                    <a href="#" class="btn btn-light btn-sm-square rounded-circle"><i class="fab fa-instagram text-secondary"></i></a>
                    <a href="#" class="btn btn-light btn-sm-square rounded-circle me-0"><i class="fab fa-tiktok text-secondary"></i></a>
                </div>
            </div>
        </div>

        <!-- Navbar -->
        <div class="container px-0">
            <nav class="navbar navbar-light navbar-expand-xl py-3">
                <!-- Logo -->
                <a th:href="@{/}" class="navbar-brand">
                    <h1 class="text-primary display-6">Baby<span class="text-secondary">Care</span></h1>
                </a>

                <!-- Nút toggle trên mobile -->
                <button class="navbar-toggler py-2 px-3" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
                    <span class="fa fa-bars text-primary"></span>
                </button>

                <!-- Menu -->
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <!-- Menu giữa -->
                    <div class="navbar-nav mx-auto">
                        <a th:href="@{/home}" class="nav-item nav-link" th:classappend="${activePage == 'home' ? ' active' : ''}">Home</a>
                        <a th:href="@{/about}" class="nav-item nav-link" th:classappend="${activePage == 'about' ? ' active' : ''}">About</a>
                        <a th:href="@{/service}" class="nav-item nav-link" th:classappend="${activePage == 'service' ? ' active' : ''}">Services</a>
                        <a th:href="@{/program}" class="nav-item nav-link" th:classappend="${activePage == 'program' ? ' active' : ''}">Programs</a>
                        <a th:href="@{/event}" class="nav-item nav-link" th:classappend="${activePage == 'event' ? ' active' : ''}">Events</a>

                        <div class="nav-item dropdown">
                            <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" th:classappend="${activePage == 'pages' ? ' active' : ''}">Pages</a>
                            <div class="dropdown-menu m-0 bg-secondary rounded-0">
                                <a th:href="@{/blog}" class="dropdown-item">Our Blog</a>
                                <a th:href="@{/team}" class="dropdown-item">Our Team</a>
                                <a th:href="@{/testimonial}" class="dropdown-item">Testimonial</a>
                                <a th:href="@{/404}" class="dropdown-item">404 Page</a>
                            </div>
                        </div>

                        <a th:href="@{/contact}" class="nav-item nav-link" th:classappend="${activePage == 'contact' ? ' active' : ''}">Contact</a>
                    </div>

                    <div class="d-flex align-items-center gap-4 ms-3">
                        <button type="button" class="btn btn-outline-primary d-flex align-items-center gap-2"
                                data-bs-toggle="modal" data-bs-target="#cartModal">
                            <i class="fas fa-shopping-cart"></i>
                            <span>Giỏ hàng</span>
                            <span class="badge bg-danger rounded-pill">2</span>
                        </button>

                        <!-- Modal Giỏ hàng -->
                        <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg modal-dialog-centered">
                                <div class="modal-content rounded-0">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="cartLabel">Giỏ hàng khóa học</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                                    </div>

                                    <div class="modal-body">
                                        <div class="table-responsive">
                                            <table class="table align-middle" id="cartTable">
                                                <thead>
                                                <tr>
                                                    <th>Khóa học</th>
                                                    <th>Mã KH</th>
                                                    <th>Giảng viên</th>
                                                    <th>Giá</th>
                                                    <th>Số lượng</th>
                                                    <th>Tạm tính</th>
                                                    <th></th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                <tr data-course-id="KH001" data-price="500000">
                                                    <td class="align-middle">Khóa học Piano cho bé</td>
                                                    <td class="align-middle">KH001</td>
                                                    <td class="align-middle">Nguyễn Văn A</td>
                                                    <td class="align-middle price-cell">500.000đ</td>
                                                    <td>
                                                        <div class="input-group input-group-sm">
                                                            <label>
                                                                <input type="number" class="form-control text-center quantity-input" min="1" value="1" style="width:60px;">
                                                            </label>
                                                        </div>
                                                    </td>
                                                    <td class="align-middle subtotal-cell">500.000đ</td>
                                                    <td class="align-middle">
                                                        <button class="btn btn-sm btn-outline-danger remove-row">Xóa</button>
                                                    </td>
                                                </tr>

                                                <tr data-course-id="KH002" data-price="300000">
                                                    <td class="align-middle">Khóa học Vẽ sáng tạo</td>
                                                    <td class="align-middle">KH002</td>
                                                    <td class="align-middle">Trần Thị B</td>
                                                    <td class="align-middle price-cell">300.000đ</td>
                                                    <td>
                                                        <div class="input-group input-group-sm">
                                                            <label>
                                                                <input type="number" class="form-control text-center quantity-input" min="1" value="1" style="width:60px;">
                                                            </label>
                                                        </div>
                                                    </td>
                                                    <td class="align-middle subtotal-cell">300.000đ</td>
                                                    <td class="align-middle">
                                                        <button class="btn btn-sm btn-outline-danger remove-row">Xóa</button>
                                                    </td>
                                                </tr>
                                                </tbody>

                                                <tfoot>
                                                <tr>
                                                    <td colspan="4"></td>
                                                    <td class="text-end"><strong>Tổng:</strong></td>
                                                    <td colspan="2"><strong id="cartTotal">800.000đ</strong></td>
                                                </tr>
                                                </tfoot>
                                            </table>
                                        </div>

                                        <div class="d-flex justify-content-end gap-2">
                                            <a href="/cart" class="btn btn-outline-secondary">Xem giỏ hàng</a>
                                            <button class="btn btn-primary" id="checkoutBtn">Thanh toán</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="button" class="btn btn-primary d-flex align-items-center gap-2"
                                data-bs-toggle="modal" data-bs-target="#loginModal">
                            <i class="fas fa-user"></i>
                            <span>Đăng nhập</span>
                        </button>

                        <!-- Modal Đăng nhập -->
                        <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginLabel" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content rounded-0">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="loginLabel">Đăng nhập</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                                    </div>

                                    <div class="modal-body">
                                        <form action="#" method="post" class="px-2" id="loginForm">
                                            <div class="mb-3">
                                                <label for="loginUsername" class="form-label">Tên đăng nhập / Email</label>
                                                <input type="text" id="loginUsername" name="username" class="form-control" placeholder="Nhập email hoặc tên đăng nhập">
                                            </div>

                                            <div class="mb-3 position-relative">
                                                <label for="loginPassword" class="form-label">Mật khẩu</label>
                                                <div class="input-group">
                                                    <input type="password" id="loginPassword" name="password" class="form-control" placeholder="Nhập mật khẩu" aria-describedby="toggleLoginPwd">
                                                    <button class="btn btn-outline-secondary" type="button" id="toggleLoginPwd" aria-label="Hiện mật khẩu">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </div>
                                            </div>

                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <div class="form-check">
                                                    <input type="checkbox" class="form-check-input" id="remember">
                                                    <label for="remember" class="form-check-label">Ghi nhớ</label>
                                                </div>
                                                <a href="#" class="small">Quên mật khẩu?</a>
                                            </div>

                                            <button type="submit" class="btn btn-primary w-100">Đăng nhập</button>

                                            <div class="text-center mt-3">
                                                <small>Chưa có tài khoản?
                                                    <!-- link chuyển sang modal đăng ký: đóng login và mở register -->
                                                    <a href="#" data-bs-target="#registerModal" data-bs-toggle="modal" data-bs-dismiss="modal">Đăng ký</a>
                                                </small>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Modal Đăng ký -->
                        <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerLabel" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content rounded-0">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="registerLabel">Đăng ký</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                                    </div>

                                    <div class="modal-body">
                                        <form action="#" method="post" id="registerForm" class="px-2">
                                            <div class="mb-3">
                                                <label for="regFullname" class="form-label">Họ và tên</label>
                                                <input type="text" id="regFullname" name="fullname" class="form-control" placeholder="Họ và tên">
                                            </div>

                                            <div class="mb-3">
                                                <label for="regUsername" class="form-label">Tên đăng nhập</label>
                                                <input type="text" id="regUsername" name="username" class="form-control" placeholder="Tên đăng nhập">
                                            </div>

                                            <div class="mb-3">
                                                <label for="regEmail" class="form-label">Email</label>
                                                <input type="email" id="regEmail" name="email" class="form-control" placeholder="Email">
                                            </div>

                                            <div class="mb-3">
                                                <label for="regPhone" class="form-label">Số điện thoại</label>
                                                <input type="text" id="regPhone" name="phone" class="form-control" placeholder="Số điện thoại">
                                            </div>

                                            <div class="mb-3 position-relative">
                                                <label for="regPassword" class="form-label">Mật khẩu</label>
                                                <div class="input-group">
                                                    <input type="password" id="regPassword" name="password" class="form-control" placeholder="Mật khẩu" aria-describedby="toggleRegPwd">
                                                    <button class="btn btn-outline-secondary" type="button" id="toggleRegPwd" aria-label="Hiện mật khẩu">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </div>
                                            </div>

                                            <div class="mb-3 position-relative">
                                                <label for="regConfirm" class="form-label">Xác nhận mật khẩu</label>
                                                <div class="input-group">
                                                    <input type="password" id="regConfirm" name="confirmPassword" class="form-control" placeholder="Nhập lại mật khẩu" aria-describedby="toggleRegConfirm">
                                                    <button class="btn btn-outline-secondary" type="button" id="toggleRegConfirm" aria-label="Hiện mật khẩu">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </div>
                                            </div>

                                            <div class="mb-3 text-danger small" id="registerError" style="display:none;"></div>

                                            <button type="submit" class="btn btn-primary w-100">Đăng ký</button>

                                            <div class="text-center mt-3">
                                                <small>Đã có tài khoản? <a href="#" data-bs-target="#loginModal" data-bs-toggle="modal" data-bs-dismiss="modal">Đăng nhập</a></small>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </nav>
        </div>
    </div>

    <script>
        function formatVND(n) {
            return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + "đ";
        }

        function toInt(v) {
            return Math.round(Number(v) || 0);
        }

        function recalcRow(row) {
            const price = toInt(row.dataset.price);
            const qtyInput = row.querySelector('.quantity-input');
            let qty = parseInt(qtyInput.value, 10) || 0;
            if (qty < 1) qty = 1, qtyInput.value = 1;
            const subtotal = price * qty;
            row.querySelector('.subtotal-cell').textContent = formatVND(subtotal);
            return subtotal;
        }

        function recalcCart() {
            const rows = Array.from(document.querySelectorAll('#cartTable tbody tr'));
            const total = rows.reduce((sum, r) => sum + recalcRow(r), 0);
            document.getElementById('cartTotal').textContent = formatVND(total);
            return total;
        }

        document.addEventListener('DOMContentLoaded', function(){
            recalcCart();

            document.querySelector('#cartTable').addEventListener('click', function(e){
                if (e.target.matches('.quantity-increase')) {
                    const row = e.target.closest('tr');
                    const input = row.querySelector('.quantity-input');
                    input.value = parseInt(input.value || 0, 10) + 1;
                    recalcCart();
                } else if (e.target.matches('.quantity-decrease')) {
                    const row = e.target.closest('tr');
                    const input = row.querySelector('.quantity-input');
                    input.value = Math.max(1, parseInt(input.value || 0, 10) - 1);
                    recalcCart();
                } else if (e.target.matches('.remove-row')) {
                    const row = e.target.closest('tr');
                    row.remove();
                    recalcCart();
                }
            });

            document.querySelector('#cartTable').addEventListener('change', function(e){
                if (e.target.matches('.quantity-input')) {
                    const row = e.target.closest('tr');
                    if (parseInt(e.target.value,10) < 1) e.target.value = 1;
                    recalcCart();
                }
            });

            document.getElementById('checkoutBtn').addEventListener('click', function(){
                const total = recalcCart();
                if (total === 0) {
                    alert('Giỏ hàng trống.');
                    return;
                }
                window.location.href = '/checkout';
            });
        });

        function togglePasswordBtn(inputId, btnId) {
            const input = document.getElementById(inputId);
            const btn = document.getElementById(btnId);
            if(!input || !btn) return;
            btn.addEventListener('click', function(){
                if(input.type === 'password'){
                    input.type = 'text';
                    btn.querySelector('i').classList.remove('fa-eye');
                    btn.querySelector('i').classList.add('fa-eye-slash');
                } else {
                    input.type = 'password';
                    btn.querySelector('i').classList.remove('fa-eye-slash');
                    btn.querySelector('i').classList.add('fa-eye');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function(){
            togglePasswordBtn('loginPassword','toggleLoginPwd');
            togglePasswordBtn('regPassword','toggleRegPwd');
            togglePasswordBtn('regConfirm','toggleRegConfirm');

            const registerForm = document.getElementById('registerForm');
            if(registerForm){
                registerForm.addEventListener('submit', function(e){
                    const pwd = document.getElementById('regPassword').value;
                    const confirm = document.getElementById('regConfirm').value;
                    const err = document.getElementById('registerError');
                    if(pwd !== confirm){
                        e.preventDefault();
                        err.style.display = 'block';
                        err.textContent = 'Mật khẩu và xác nhận mật khẩu không khớp.';
                        return false;
                    }
                    err.style.display = 'none';
                });
            }
        });
    </script>
</div>
